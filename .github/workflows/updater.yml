name: Generate updater latest.json

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

concurrency:
  group: updater-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  generate-latest-json:
    runs-on: ubuntu-latest
    # è‡ªåŠ¨è§¦å‘ï¼šåªå¤„ç†æ­£å¼ç‰ˆæœ¬ï¼ˆéž prereleaseï¼‰
    # æ‰‹åŠ¨è§¦å‘ï¼šå§‹ç»ˆæ‰§è¡Œ
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'release' && github.event.release.prerelease == false)
    steps:
      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          # GitHub CLI é€šå¸¸å·²ç»é¢„è£…åœ¨ GitHub Actions runner ä¸­
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Download release assets (.sig and bundles)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # èŽ·å– tagï¼šè‡ªåŠ¨è§¦å‘æ—¶ä»Ž event èŽ·å–ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶ä»Ž input èŽ·å–
          TAG="${{ github.event.release.tag_name || inputs.tag }}"
          if [ -z "$TAG" ]; then
            echo "âŒ Error: No tag specified"
            exit 1
          fi
          echo "ðŸ“¦ Downloading assets for tag: $TAG"
          mkdir -p assets
          cd assets
          gh release download "$TAG" --repo "${{ github.repository }}" --clobber

      - name: Generate latest.json
        env:
          REPO: ${{ github.repository }}
          TAG: ${{ github.event.release.tag_name || inputs.tag }}
          RELEASE_BODY: ${{ github.event.release.body || '' }}
          PUB_DATE: ${{ github.event.release.published_at || '' }}
        run: |
          cd assets

          VERSION="$TAG"
          # å¦‚æžœæ²¡æœ‰ published_atï¼Œä½¿ç”¨å½“å‰æ—¶é—´
          if [ -z "$PUB_DATE" ]; then
            PUB_DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          fi

          BASE_URL="https://github.com/$REPO/releases/download/$TAG"

          # Tauri å®žé™…ç”Ÿæˆçš„æ–‡ä»¶åï¼ˆæ³¨æ„ç©ºæ ¼å’Œå‘½åè§„èŒƒï¼ï¼‰
          # Windows: .nsis.zip ç”¨äºŽæ›´æ–°ï¼Œä¸æ˜¯ .exe
          WIN_FILE="Antigravity Agent_${VERSION#v}_x64-setup.nsis.zip"
          WIN_SIG_FILE="$WIN_FILE.sig"

          # macOS: æ–‡ä»¶ååŒ…å«ç©ºæ ¼ï¼Œæž¶æž„åŽç¼€åœ¨é‡å‘½åæ­¥éª¤ä¸­æ·»åŠ 
          MAC_ARM_FILE="Antigravity Agent_aarch64.app.tar.gz"
          MAC_ARM_SIG_FILE="$MAC_ARM_FILE.sig"
          MAC_X64_FILE="Antigravity Agent_x86_64.app.tar.gz"
          MAC_X64_SIG_FILE="$MAC_X64_FILE.sig"

          # Linux: Tauri ä½¿ç”¨ Debian å‘½åè§„èŒƒ (amd64 è€Œéž x86_64)
          LINUX_FILE="antigravity-agent_${VERSION#v}_amd64.AppImage.tar.gz"
          LINUX_SIG_FILE="$LINUX_FILE.sig"

          # è¯»å–ç­¾åæ–‡ä»¶ï¼ˆTauri ç­¾åæ–‡ä»¶å†…å®¹æ˜¯ base64 ç¼–ç ï¼‰
          get_sig() {
            local f="$1"
            if [ -f "$f" ]; then
              cat "$f"
            else
              echo ""
            fi
          }

          SIG_WIN=$(get_sig "$WIN_SIG_FILE")
          SIG_MAC_ARM=$(get_sig "$MAC_ARM_SIG_FILE")
          SIG_MAC_X64=$(get_sig "$MAC_X64_SIG_FILE")
          SIG_LINUX=$(get_sig "$LINUX_SIG_FILE")

          # URL ç¼–ç ç©ºæ ¼ä¸º %20
          URL_WIN="$BASE_URL/${WIN_FILE// /%20}"
          URL_MAC_ARM="$BASE_URL/${MAC_ARM_FILE// /%20}"
          URL_MAC_X64="$BASE_URL/${MAC_X64_FILE// /%20}"
          URL_LINUX="$BASE_URL/$LINUX_FILE"

          # ä½¿ç”¨ jq å®‰å…¨ç”Ÿæˆ JSONï¼Œæ­£ç¡®å¤„ç†ç‰¹æ®Šå­—ç¬¦å’Œè½¬ä¹‰
          jq -n \
            --arg version "$VERSION" \
            --arg notes "$RELEASE_BODY" \
            --arg pub_date "$PUB_DATE" \
            --arg sig_win "$SIG_WIN" \
            --arg url_win "$URL_WIN" \
            --arg sig_mac_arm "$SIG_MAC_ARM" \
            --arg url_mac_arm "$URL_MAC_ARM" \
            --arg sig_mac_x64 "$SIG_MAC_X64" \
            --arg url_mac_x64 "$URL_MAC_X64" \
            --arg sig_linux "$SIG_LINUX" \
            --arg url_linux "$URL_LINUX" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "windows-x86_64": {
                  signature: $sig_win,
                  url: $url_win
                },
                "darwin-aarch64": {
                  signature: $sig_mac_arm,
                  url: $url_mac_arm
                },
                "darwin-x86_64": {
                  signature: $sig_mac_x64,
                  url: $url_mac_x64
                },
                "linux-x86_64": {
                  signature: $sig_linux,
                  url: $url_linux
                }
              }
            }' > latest.json

          echo "âœ… Generated latest.json:"
          cat latest.json

      - name: Upload latest.json to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name || inputs.tag }}"
          cd assets
          gh release upload "$TAG" latest.json --repo "${{ github.repository }}" --clobber
